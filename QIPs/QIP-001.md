
```
QIP: 001
Layer: Peer Services
Title: Federated Signet PSBT Relay Protocol
Authors: Johnny Santos <johnnysantos@protonmail.com>
         Davidson Souza <qip@dlsouza.lol>
         Lucas Balieiro <contact@lucasbalieiro.dev>
Status: Draft
Type: Specification
Assigned: 2026-02-24
License: CC0
```

---

## Abstract

This specification defines a P2P message protocol for federated signet networks with an arbitrary Taproot Multisig Quorum. The protocol enables cooperative block signing through flood-fill propagation of partially signed PSBTs, using SipHash-2-4 derived short IDs for deduplication (per BIP-152) [^1].

## 1. Overview

### 1.1 Motivation

Signet (BIP-325) [^2] provides a test network with signature requirements. This protocol extends signet for federated n-of-m threshold signing using Taproot (BIP-341) [^3].

### 1.2 Architecture

- **Quorum:** 100 Taproot public keys (threshold: 10)
- **Signing:** Descriptor based multisig
- **Relay:** Push-based flood fill with deduplication

### 1.3 Session Initiation

A signing session begins when no valid block has been received for `60` seconds, or via RPC.
Any federation member may initiate the signing session.

---

## 2. The `signetpsbt` Message

The message MUST have the following `cmdString`: `signetpsbt` (12 bytes, null-padded)

For the v2 transport it MUST have the id `30`.

### 2.1 Message Format

| Field                      | Type             | Size               | Description |
|----------------------------|------------------|--------------------|-------------|
| `nonce`                    | `uint64`         | 8 bytes            | Random per-session nonce |
| `psbt_length`              | `compactsize`    | Variable           | The size of the following field |
| `psbt`                     | `psbt`           | Variable           | Serialized PSBT (the `to_sign` virtual transaction per BIP-325) |
| `block_template_length`    | `compactsize`    | Variable           | The size of the following field |
| `block_template`           | `block_template` | Variable           | Serialized block template (for the 10th signer to construct the final block) |
| `signers_short_ids_length` | `compactsize`    | Variable           | The size of the following field |
| `signers_short_ids`        | `short_id array` | 8 bytes per item   | Array of 8-byte short IDs derived from federation member public keys |

All the encodings are little endian.

### 2.2 Short Signer ID

```
short_id = SipHash-2-4(key=nonce, data=pubkey)
```

Each federation member's identity is represented by an 8-byte short ID derived via SipHash-2-4. This mirrors BIP-152's short transaction ID mechanism [^1].

### 2.3 Message Flow

The following diagram illustrates the message flow for a typical signing session:

```
+--------+     signetpsbt      +--------+
| Node A | ------------------> | Node B |
| (init) |  (nonce, PSBT,      |        |
|        |   signers=[A],      |        |
+--------+   block_template)   +--------+
                                |
                         signetpsbt
                                |
                                v
                         +--------+     signetpsbt      +--------+
                         | Node C | ------------------> | Node D |
                         |        |  (signers=[A,B],    |        |
                         +--------+   PSBT+sig_C)       +--------+
                                |                         |
                                |                   signetpsbt
                                |                         |
                                v                         v
                         +--------+                 +--------+
                         | Node E | ...             | Node N |
                         |        |                 |        |
                         +--------+                 +--------+
                                |
                         [10 signatures]
                                |
                                v
                    +------------------------+
                    | Any node (10th signer) |
                    | Builds block, publishes|
                    | via block/cmpctblock   |
                    +------------------------+
```

---

## 3. Relay Rules

### 3.1 Processing Order

A node receiving `signetpsbt` MUST:

1. **No echo back:** Do NOT relay to the peer that sent the message.
2. **Already signed:** If `SipHash(nonce, my_pubkey)` exists in `signers_short_ids`, drop the message.
3. **Validate SIGNERS:** Verify every short ID matches a known federation member (QIP-001). Ban peer if invalid.
4. **Validate signature:** Ensure the provided signatures are valid for the given PSBT inputs. This includes checking that the short-ids are mapped one to one with the signatures in the PSBT. Ban peer if invalid.
5. **Sign and relay:** If not yet signed, sign PSBT, append own short ID, relay to other peers.
6. **Threshold:** If `len(signers_short_ids) >= 10`, any node MAY build and publish the block via standard `block` or `cmpctblock` messages.
7. **Surrender:** If a block is found while in a session, drop all current signing sessions. We can check the height on the block template.

### 3.2 DoS Protection

Invalid signer short IDs result in immediate peer banning. This prevents spoofing attacks.

---

## 4. Block Publication

When 10 signatures are collected:

1. The node constructs the complete block using `block_template` and the fully-signed PSBT.
2. The node grinds the block nonce to meet target difficulty like the usual mining process.
3. The block is published via standard Bitcoin P2P `block` or `cmpctblock` messages.
4. PSBT relay continues (multiple miners may attempt to publish).

---

## 5. Implementation Hints

### 5.1 Reference implementation

Register message in `src/protocol.h`:

```cpp
namespace NetMsgType {
    static const char* SIGNETPSBT = "signetpsbt";
}
```

Handle in `src/net_processing.cpp`:

```cpp
if (msg_type == NetMsgType::SIGNETPSBT) {
    return ProcessSignetPsbt(pfrom, vRecv, ban_node);
}
```

## References

[^1]: [BIP-152: Compact Block Relay](https://bips.dev/152/)
[^2]: [BIP-325: Signet](https://bips.dev/325/)
[^3]: [BIP-341: Taproot](https://bips.dev/341/)
[^4]: [BIP-174: PSBT](https://bips.dev/174/)
